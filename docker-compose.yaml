version: '3.8'

services:
  gateway:
    image: nginx:latest
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8888:80"
    depends_on:
      - app1
      - app2

  # Shared database for users, videos (posts), comments, etc.
  db_shared:
    image: postgres:15
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    ports:
      - "5434:5432"
    volumes:
      - pgdata_shared:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # Replica 1's database for post_metrics
  db1:
    image: postgres:15
    environment:
      POSTGRES_DB: ${DATABASE_NAME}_metrics
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    ports:
      - "5435:5432"
    volumes:
      - pgdata1:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # Replica 2's database for post_metrics
  db2:
    image: postgres:15
    environment:
      POSTGRES_DB: ${DATABASE_NAME}_metrics
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    ports:
      - "5436:5432"
    volumes:
      - pgdata2:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 5s
      timeout: 5s
      retries: 5

  app1:
    build: .
    environment:
      # Primary datasource - shared database
      DATABASE_HOST: db_shared
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      # Secondary datasource - replica-specific metrics database
      METRICS_DATABASE_HOST: db1
      METRICS_DATABASE_PORT: 5432
      METRICS_DATABASE_NAME: ${DATABASE_NAME}_metrics
      METRICS_DATABASE_USERNAME: ${DATABASE_USERNAME}
      METRICS_DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      SERVER_PORT: 8080
      MY_EMAIL_ADDRESS: ${MY_EMAIL_ADDRESS:-mock@gmail.com}
      MY_APP_PASSWORD: ${MY_APP_PASSWORD:-password}
    ports:
      - "8081:8080"
    volumes:
      - media1:/app/media
    depends_on:
      db_shared:
        condition: service_healthy
      db1:
        condition: service_healthy

  app2:
    build: .
    environment:
      # Primary datasource - shared database
      DATABASE_HOST: db_shared
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      # Secondary datasource - replica-specific metrics database
      METRICS_DATABASE_HOST: db2
      METRICS_DATABASE_PORT: 5432
      METRICS_DATABASE_NAME: ${DATABASE_NAME}_metrics
      METRICS_DATABASE_USERNAME: ${DATABASE_USERNAME}
      METRICS_DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      SERVER_PORT: 8081
      MY_EMAIL_ADDRESS: ${MY_EMAIL_ADDRESS:-mock@gmail.com}
      MY_APP_PASSWORD: ${MY_APP_PASSWORD:-password}
    ports:
      - "8082:8081"
    volumes:
      - media2:/app/media
    depends_on:
      db_shared:
        condition: service_healthy
      db2:
        condition: service_healthy

volumes:
  pgdata_shared:
  pgdata1:
  pgdata2:
  media1:
  media2:
